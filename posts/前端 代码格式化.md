---
title: å‰ç«¯ä»£ç æ ¼å¼åŒ–
date: 2021-05-17 18:13:02
category: category
tag: JavaScript,è§„èŒƒ
cover: 
description: ä½¿ç”¨husky+lint-stagedé…åˆeslintåœ¨æ¯æ¬¡commitä¹‹å‰è§„èŒƒç¼–ç é£æ ¼
---

### å‰è¨€

è™½ç„¶ç°åœ¨å…¬å¸çš„å‰ç«¯åªæœ‰æˆ‘ä¸€ä¸ªï¼Œä½†æ˜¯å‰ç«¯é¡¹ç›®è¯¥åšçš„ä»£ç ç»Ÿä¸€é£æ ¼è¿˜æ˜¯è¦åšçš„ ğŸŒ¹ğŸ”ã€‚æœ¬æ–‡å°è¯• ä½¿ç”¨husky+lint-stagedåœ¨æ¯æ¬¡ `git commit` æ—¶æ‰§è¡Œ `eslint --fix`æ ¼å¼åŒ–ä»£ç ã€‚

### ä½¿ç”¨æ•™ç¨‹

#### husky 

åœ¨ä½ æ¯æ¬¡æ•²å‡º`git commit`ä¹‹åï¼Œä½ æ˜¯ä¸æ˜¯å¸¸å¸¸ä¼šæ„Ÿåˆ°åæ‚”ï¼Ÿä¸ºäº†å‡†æ—¶ä¸‹ç­ï¼Œæ¶‚æ¶‚æ”¹æ”¹çš„ä»£ç ä¸åŠ ä¿®é¥°å°±æåˆ°äº†å…¬å¸gitä»“åº“ä¸Šé¢ï¼Œç”šè‡³åŒ…å«ä¸€äº›å†—ä½™ã€é”™è¯¯(!)çš„ä»£ç ã€‚è¿˜å¥½æˆ‘ç°åœ¨åªæœ‰ä¸€ä¸ªäººï¼Œæ‹‰çš„å±æ²¡äººçœ‹å¾—è§ï¼Œä¸ç„¶ä¸å¾—è¢«åŒäº‹æ‰“æ­»ã€‚ã€‚ã€‚husky(å“ˆå£«å¥‡)ï¼Œå°±åƒæ¸…ç†ç²ªä¾¿çš„å¨çŒ›å…ˆç”Ÿï¼Œå³ä½¿ä¸“é—¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚å®ƒä¼šåœ¨ä½ `commit`ä¹‹å‰ï¼Œæ ¼å¼åŒ–ä½ çš„ä»£ç å‘€ï¼Œè·‘è·‘ä½ å†™çš„å•å…ƒæµ‹è¯•å‘€ï¼Œç”Ÿæˆè¯´æ˜æ–‡æ¡£å‘€ç­‰ç­‰ä¹‹ç±»çš„ã€‚æ˜¯å°†ä½ çš„ä»£ç èµ„äº§é€è‡³å…¬æœ‰(å…¬å¸æ‹¥æœ‰)å‰çš„æœ€åä¸€é“é”ã€‚

##### å®‰è£…(update: ç°åœ¨ list-stagedå¯ä»¥ç›´æ¥æ•´åˆhuskyè¿›è¡Œå®‰è£…ï¼Œå¯ä»¥è·³è¿‡huskyçš„å®‰è£…ï¼Œç›´æ¥å»list-staged)

`husky` å¤§æ¦‚åœ¨ v4.0ä¹‹åçš„å®‰è£…å’Œä½¿ç”¨ä¸ä¹‹å‰æœ‰äº†å¤©ç¿»åœ°è¦†çš„å˜åŒ–ï¼Œä¹‹å‰åªæ˜¯ä½¿ç”¨è¿‡v1.xçš„ç‰ˆæœ¬ï¼Œæ–°çš„ç‰ˆæœ¬ç›´æ¥è®©æˆ‘çœ¼å‰ä¸€æ„£ã€‚ã€‚ã€‚

`husky`æä¾›äº†ä¸€ä¸ª`husky-init`çš„å‘½ä»¤è¡Œå·¥å…·å¸®åŠ©é¡¹ç›®å®‰è£…`husky`,

```bash
npx husky-init && npm install       # npm
npx husky-init && yarn              # Yarn 1
yarn dlx husky-init --yarn2 && yarn # Yarn 2
```

è¯¥`bash`ä¼šåœ¨å½“å‰é¡¹ç›®å®‰è£…`husky`,ç¼–è¾‘`package.json`å¹¶ä¸”åˆ›å»ºä¸€ä¸ª`.husky`æ–‡ä»¶å¤¹ï¼Œé‡Œé¢é¢„ç½®ä¸€ä¸ª`pre-commit`é’©å­, è¿™ä¸ªé’©å­ä¼šåœ¨ æ¯æ¬¡commitä¹‹å‰è·‘ä¸€é`npx test`ã€‚å¦‚ä½ æ‰€è§ï¼Œæˆ‘ä»¬æœ€åä¼šåœ¨è¿™é‡ŒåŠ¨æ–‡ç« ã€‚

```bash
# .husky/pre-commit
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"
npm test
```

å³åœ¨æ¯æ¬¡commitä¹‹å‰åœ¨è¿™é‡Œè¿è¡Œæ ¼å¼åŒ–ä»£ç çš„è„šæœ¬ï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œå…ˆæ¥å¤§è‡´ä»‹ç»ä¸€ä¸‹æ ¼å¼åŒ–ä»£ç çš„å·¥å…·`eslint`

#### Eslint

eslintæ˜¯ä¸€ä¸ªå·¥å…·ï¼Œä¸¤ä¸ªç”¨é€”ï¼šä»£ç æ ¼å¼åŒ–ã€æ£€æµ‹ä»£ç å¸¸è§è¯­æ³•é”™è¯¯ã€‚

##### å®‰è£…

```bash
npm install eslint --save-dev		# npm
yarn add eslint --save-dev			# yarn
```

æ‰§è¡Œ`npx eslint --init`ï¼Œä¼šé—®ä½ å‡ ä¸ªé—®é¢˜ï¼ŒæŒ‰ç…§å®é™…é¡¹ç›®çš„éœ€æ±‚å›ç­”å°±å¯ä»¥ï¼Œä¼šç”Ÿæˆä¸€ä¸ª`eslint`çš„é…ç½®æ–‡ä»¶ã€‚

![image-20210518001736137](http://img.massivejohn.com/image-20210518001736137.png)

æ ¹æ®æˆ‘çš„é…ç½®ï¼Œä¼šåœ¨é¡¹ç›®çš„æ ¹æ–‡ä»¶å¤¹åˆ›å»ºä¸€ä¸ª`.eslintrc.json`æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶æ˜¯ç”¨æ¥é…ç½®eslintè§„åˆ™çš„ä¸€ä¸ªå…¥å£ï¼ˆå¦ä¸€ä¸ªæ˜¯package.jsonæ–‡ä»¶ä¸­çš„eslintConfigå­—æ®µï¼Œcreate-react-appçš„é¡¹ç›®å°±æ˜¯è¿™æ ·è®¾è®¡çš„ã€‚

åœ¨`eslint.json`æ–‡ä»¶ä¸­ï¼Œæœ‰ä¸¤ä¸ªå­—æ®µ`extends`å’Œ`rules`ç”¨æ¥è®¾ç½®è§„åˆ™é›†åˆå’Œè‡ªå®šä¹‰è§„åˆ™ã€‚

æ‰§è¡Œ `npx eslint --fix . ` ä¼šæ£€æŸ¥`src`æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶æ˜¯ä¸æ˜¯æœ‰ä¸ç¬¦åˆè§„èŒƒçš„ä»£ç ã€‚

æœ‰äº†`husky`å’Œ`eslint`ï¼Œå…¶å®å°±å¯ä»¥åšåˆ°åœ¨æ¯æ¬¡`commit`ä¹‹å‰éƒ½è·‘ä¸€éå…¨å±€çš„`eslint --fix .`ã€‚ç„¶è€Œå¦‚æœéšç€ä½ çš„ä»£ç å †ç§¯æˆå±±ï¼Œå°±ä¼šå‘ç°æ¯æ¬¡commitéƒ½è¦ç­‰å¾ˆä¹…çš„æ—¶é—´ã€‚å¹¶ä¸”æ²¡æœ‰ä¿®æ”¹çš„ä»£ç ä¸ºä»€ä¹ˆè¿˜è¦å†æ ¼å¼åŒ–ä¸€éå‘¢ï¼Ÿå› æ­¤`lint-staged`åº”è¿è€Œç”Ÿ.

#### lint-staged

 æ¯ä¸ªäººéƒ½å–œæ¬¢ç»Ÿä¸€æ ¼å¼çš„ä»£ç ï¼Œåœ¨commitæäº¤ä¹‹å‰ä¿è¯ä»£ç å·²ç»æ ¼å¼åŒ–å°¤ä¸ºé‡è¦ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨æ¯æ¬¡æäº¤å‰éƒ½è¿›è¡Œæ ¼å¼åŒ–ï¼Œä½†æ˜¯å¦‚æœæ¯æ¬¡éƒ½æ ¼å¼åŒ–æ•´ä¸ªé¡¹ç›®çš„è¯ï¼Œé€Ÿåº¦å¾ˆæ…¢å¹¶ä¸”æ˜¾å¾—æ²¡æœ‰å¿…è¦ï¼Œæœ‰ç‚¹åƒ''ä½ å°±æ˜¯ä¸­å›½''çš„æ„Ÿè§‰ã€‚lint-staged ä¼šåœ¨æ¯æ¬¡commitä¹‹å‰ä»…ä»…æ ¼å¼åŒ–å¾…æäº¤çš„ä»£ç ã€‚

##### å®‰è£…

lint-staged æä¾›äº†ä¸€ä¸ª mrmå·¥å…· æ•´åˆäº†`husky`ã€`lint-staged`å’Œ`eslint`ç­‰æ ¼å¼åŒ–å·¥å…·ã€‚æ‰€ä»¥åªè¦ä½ åœ¨é¡¹ç›®ä¸­å®‰è£…é—®eslintä¹‹åï¼Œå¯ä»¥ç›´æ¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
npx mrm@2 lint-staged && npm install	# npm
npx mrm@2 lint-staged && yarn			# yarn
```

`lint-staged`ä¼šç›´æ¥å®Œæˆå¯¹`.husky`æ–‡ä»¶å¤¹ä¸‹`pre-commit`è„šæœ¬çš„çš„è®¾ç½®å¹¶ä¸”æ›´æ–°package.jsonæ–‡ä»¶ä¸­çš„`list-staged`å­—æ®µ

```bash
# .husky/pre-commit
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

npx lint-staged
```

```json
"lint-staged": {
    "*.js": "eslint --cache --fix"
}
// ç»™ä¸€ä¸ªå¦‚æœæ˜¯typescripté¡¹ç›®çš„é…ç½®
"lint-staged": {
    "*.{js,jsx,ts,tsx}": [
      "eslint --cache --fix"
    ]
  },
```

ç°åœ¨ä¿®æ”¹ä¸€ä¸‹`src`æ–‡ä»¶å¤¹é‡Œé¢çš„æ–‡ä»¶å¤¹,æ•…æ„ç¼–å†™ä¸€äº›é”™è¯¯ä»£ç :

```js
function App() {
  const bb = 'hello'
bb = 111
  ...
}
```

æ‰§è¡Œ`git add .`ï¼Œå†æ‰§è¡Œ`npx lint-staged`ï¼ˆæ³¨æ„ï¼Œéœ€è¦å…ˆä½¿ç”¨lint-stagedéªŒè¯ä¸€ä¸‹ï¼Œä¸ç„¶å°±æœ‰å¯èƒ½ç›´æ¥commitä¸Šå»äº†)

![image-20210519011339005](http://img.massivejohn.com/image-20210519011339005.png)

å¤§åŠŸå‘Šæˆï¼è¿™æ ·çš„è¯ï¼Œæ¯æ¬¡ä½ çš„ä»£ç åœ¨æäº¤çš„æ—¶å€™éƒ½ä¼šè‡ªåŠ¨æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦ç¬¦åˆè§„èŒƒã€‚

### æ€»ç»“

å‰ç«¯ä»£ç è§„èŒƒä¸»è¦æ˜¯ç”±ä¸‰ä¸ªæ–¹é¢ç»„æˆ, `husky`è´Ÿè´£æä¾›`git commit`çš„é’©å­ã€`Eslint`è´Ÿè´£è§„èŒƒä»£ç æ ¼å¼ä¸è´¨é‡ï¼Œè€Œ`lint-staged`å°±æ˜¯è¿æ¥äºŒè€…çš„æ¡¥æ¢ã€‚

